<!DOCTYPE html>
<html>
<head>
	<title>Passcode Generator</title>
	<script type="text/javascript" src="crypto-sha256.js" defer></script>
	<script type="text/javascript" charset="utf-8">
	
		function get_hostname_from_url(url) {	// Extracts domain from full URL
		    var splat = url.split(/\/+/g)[1];
		    var splats = new Array(splat.split("\."));
		    alert(splats[splats.length-1]);
		    return splat;
		}
	
		function hash(domain, password) {
			var hash = Crypto.SHA256(domain + password);
			return hash.substr(0,16);
		}

		function performCommand(event) {
			if (event.command === "encrypt") {
			var auto_domain = get_hostname_from_url(safari.application.activeBrowserWindow.activeTab.url);
			
				// Domain
				if (safari.extension.settings.getItem('auto_domain') == true)
					var domain = safari.extension.settings.getItem('auto_domain');
				else
					var domain = prompt("Current Domain:", safari.extension.settings.getItem('auto_domain'));
				
				// Password
				if (safari.extension.secureSettings.getItem('master_password') == null)
					var password = prompt("Master Password:", "");
				else
					var password = safari.extension.secureSettings.getItem('master_password');
				
				// Generated Hash
				var generated_hash = hash(domain, password);
				if (safari.extension.settings.getItem('auto_fill') == true)
					prompt("Your generated passcode is:", generated_hash);
				else
					prompt("Your generated passcode is:", generated_hash);	// Automatically fill in password fields
			}
		}

		function validateCommand(event) {
			if (event.command === "encrypt") {
				// Disable the button if there is no URL loaded in the tab.
				event.target.disabled = !event.target.browserWindow.activeTab.url;
			}
		}
 
// if event handlers are in the global HTML page,
// register with application:
safari.application.addEventListener("command", performCommand, true);
safari.application.addEventListener("validate", validateCommand, true);
</script>
</head>
<body>
</body>
</html>